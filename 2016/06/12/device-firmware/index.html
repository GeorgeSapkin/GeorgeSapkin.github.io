<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Making a Debian-based ARM device firmware - # dmesg -w</title><meta name="description" content="Making a Debian-based ARM device firmware - George Sapkin"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><h1># dmesg -w</h1><span>A blog to follow</span></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="https://github.com/GeorgeSapkin" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/contacts/" target="_self" class="nav-list-link">CONTACTS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Making a Debian-based ARM device firmware</h1><div class="post-info">Jun 12, 2016</div><div class="post-content"><p><strong>Jun 16, 2016 update:</strong> explained reasons for using Docker with QEMU.</p>
<p>For one of my previous assignments I had to automate building ARM-based device firmware and over-the-air updates. While the recovery partition of a device was relatively small and simple and could be built using <a href="https://buildroot.org/">Buildroot</a>, the root partition was based on <a href="https://www.debian.org/releases/jessie/">Debian 8 “Jessie”</a>.</p>
<p>Let’s make a firmware for a hypothetical ARM-based <a href="https://en.wikipedia.org/wiki/HAL_9000">HAL 9000</a>.</p>
<a id="more"></a>
<p>The goal is to describe the process overall and not to delve into device specifics. You still need to figure out the boot sequence, configure and build the kernel, set up partitioning and write custom setup scripts that work for <em>your</em> device.</p>
<p><strong>TL;DR:</strong> scripts for the lazy are in the <a href="#TL-DR">end</a>.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>I assume you’re using some flavor of Linux, can figure out when to use elevated privileges and you have these tools at your disposal:</p>
<ul>
<li>chroot</li>
<li>debootstrap</li>
<li>Docker</li>
<li>Statically-compiled <a href="https://wiki.debian.org/QemuUserEmulation">QEMU User Emulation</a>, aka qemu-user-static.</li>
</ul>
<p>The reason why I used Docker and QEMU User Emulation instead of just scripting in chroot was that some software needed to be cross compiled and it had complex dependencies. So compiling it natively, thanks to QEMU dynamic <a href="https://en.wikipedia.org/wiki/Binary_translation">binary translation</a>, in the same environment (i.e. OS, kernel and packages) where it’s going to run was the easiest.</p>
<h2 id="Making-a-minimal-Debian-ARM-image-using-debootstrap-and-chroot"><a href="#Making-a-minimal-Debian-ARM-image-using-debootstrap-and-chroot" class="headerlink" title="Making a minimal Debian ARM image using debootstrap and chroot"></a>Making a minimal Debian ARM image using debootstrap and chroot</h2><p>According to <a href="https://wiki.debian.org/Debootstrap">debootstraps’s website</a> it is:</p>
<blockquote>
<p>a tool which will install a Debian base system into a subdirectory of another, already installed system.</p>
</blockquote>
<p>And that’s just what we’re going to do:</p>
<h4 id="deboostrap-Stage-1"><a href="#deboostrap-Stage-1" class="headerlink" title="deboostrap Stage 1"></a>deboostrap Stage 1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rootfs_dir=rootfs</span><br><span class="line"><span class="comment"># Debian release to install. We want 8.x, hence Jessie.</span></span><br><span class="line">distro=jessie</span><br><span class="line">debootstrap --arch=armhf --foreign <span class="variable">$distro</span> <span class="variable">$rootfs_dir</span></span><br></pre></td></tr></table></figure>
<h4 id="deboostrap-Stage-2"><a href="#deboostrap-Stage-2" class="headerlink" title="deboostrap Stage 2"></a>deboostrap Stage 2</h4><p>Enable QEMU user emulation by copying <code>qemu-arm-static</code> to run ARM binaries:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qas=$(<span class="built_in">which</span> qemu-arm-static)</span><br><span class="line">cp <span class="variable">$qas</span> <span class="variable">$rootfs_dir</span><span class="variable">$qas</span></span><br></pre></td></tr></table></figure>
<p>Now start stage 2 of deboostrap:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chroot <span class="variable">$rootfs_dir</span> /debootstrap/debootstrap --second-stage</span><br></pre></td></tr></table></figure>
<p>This will take a while but in the end you’ll have a directory with a minimal Debian system, sans your device’s kernel, modules and software. At the time of this writing, I ended up with 266MB rootfs.</p>
<h4 id="Importing-minimal-Debian-rootfs-into-Docker"><a href="#Importing-minimal-Debian-rootfs-into-Docker" class="headerlink" title="Importing minimal Debian rootfs into Docker"></a>Importing minimal Debian rootfs into Docker</h4><p>Making rootfs archive:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pushd</span> . &gt; /dev/null</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$rootfs_dir</span></span><br><span class="line">tar -czf ../rootfs.tar.gz .</span><br><span class="line"><span class="built_in">popd</span> &gt; /dev/null</span><br><span class="line">rm -rf <span class="variable">$rootfs_dir</span></span><br></pre></td></tr></table></figure>
<p>Importing rootfs into Docker:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tag=<span class="string">'georgesapkin/hal9000:base'</span></span><br><span class="line">docker import rootfs.tar.gz <span class="variable">$tag</span></span><br></pre></td></tr></table></figure>
<p>Now you have a Docker Debian image that serves as a base for future firmwares. I set up a job in Jenkins to rebuild it once a week, so device firmwares are always based on the latest software.</p>
<h2 id="Installing-device-specific-kernel-modules-and-software-inside-Docker"><a href="#Installing-device-specific-kernel-modules-and-software-inside-Docker" class="headerlink" title="Installing device-specific kernel, modules and software inside Docker"></a>Installing device-specific kernel, modules and software inside Docker</h2><p>I use the base image from previous steps:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> georgesapkin/hal9000:base</span><br></pre></td></tr></table></figure>
<h4 id="Rootfs-overlay"><a href="#Rootfs-overlay" class="headerlink" title="Rootfs overlay"></a>Rootfs overlay</h4><p>All static OS configuration files and scripts are in <code>rootfs_overlay</code> directory that is applied to the base image before any other scripts are run.</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span> <span class="bash">rootfs_overlay /</span></span><br></pre></td></tr></table></figure>
<p>A good candidate for the overlay is <a href="https://en.wikipedia.org/wiki/Fstab">fstab</a> file from <code>/etc/fstab</code> that list device-specific partitions. Another one is a <a href="#dpkg-filter">dpkg filter</a> to be placed in <code>/etc/dpkg/dpkg.cfg.d/01_filter</code> to prevent some unnecessary files from being installed. There’s a good article on Ubuntu Wiki about <a href="https://wiki.ubuntu.com/ReducingDiskFootprint#Drop_unnecessary_files">reducing disk footprint</a>.</p>
<h4 id="Kernel-and-modules"><a href="#Kernel-and-modules" class="headerlink" title="Kernel and modules"></a>Kernel and modules</h4><p>This is also a good place to install the pre-built device-specific kernel and modules. Keep in mind when configuring and building a kernel for your device that some OS features (e.g. iptables, webcam support, etc.) require specific modules to be enabled. These modules can take up significant amount of space.</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span> <span class="bash">kernel/boot         /</span><br><span class="line"></span><span class="keyword">COPY</span> <span class="bash">kernel/lib/firmware /lib/</span><br><span class="line"></span><span class="keyword">COPY</span> <span class="bash">kernel/lib/modules  /lib/</span></span><br></pre></td></tr></table></figure>
<h4 id="Installing-software"><a href="#Installing-software" class="headerlink" title="Installing software"></a>Installing software</h4><p>I put all the software setup into a few scripts files, e.g. <code>setup_some_feature.sh</code>. First, since we cannot reply to any questions when installing packages we need to set:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> DEBIAN_FRONTEND=noninteractive</span><br></pre></td></tr></table></figure>
<p>Then we run <code>apt-get install</code> with <code>-y --no-install-recommends -o Dpkg::Options::=&#39;--force-confold&#39;</code> arguments. <code>force-confold</code> is needed in case we want to prevent configurations files carried over from the overlay in previous steps from being overwritten. If you are building software inside Docker, you will need to install and setup the development environment first. Here’s a likely set of packages that you might need when building software:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y \</span><br><span class="line">    --no-install-recommends \</span><br><span class="line">    -o Dpkg::Options::=<span class="string">'--force-confold'</span> \</span><br><span class="line">    build-essential \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    git \</span><br><span class="line">    python</span><br></pre></td></tr></table></figure>
<p>If your device has Wi-Fi or networking capabilities that you manage from scripts, you might need one or more of the following packages:</p>
<ul>
<li>crda</li>
<li>isc-dhcp-client</li>
<li>iw</li>
<li>wireless-tools</li>
<li>wpasupplicant</li>
</ul>
<p>In case you have software that needs elevated privileges that is configured to do so via a  <code>/etc/sudoers.d/*</code> file, you will need to install the <code>sudo</code> package.</p>
<p>The relevant part of the Dockerfile to run the setup scripts:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span> <span class="bash">setup_some_feature.sh /scripts/</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">/scripts/setup_some_feature.sh</span></span><br></pre></td></tr></table></figure>
<h4 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h4><p>I put pre-image-authoring cleanup into <code>author.sh</code>. First, let’s get rid of any packages that might be left over from the build environment and some other misc packages that are not needed in the final image, remove unused dependencies and clean Apt cache:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apt-get remove -y \</span><br><span class="line">    binutils \</span><br><span class="line">    build-essential \</span><br><span class="line">    cpp \</span><br><span class="line">    cpp-4.9 \</span><br><span class="line">    dpkg-dev \</span><br><span class="line">    g++ \</span><br><span class="line">    g++-4.9 \</span><br><span class="line">    gcc \</span><br><span class="line">    gcc-4.9 \</span><br><span class="line">    git \</span><br><span class="line">    git-man \</span><br><span class="line">    libc6-dev \</span><br><span class="line">    libc-dev-bin \</span><br><span class="line">    libgcc-4.9-dev \</span><br><span class="line">    linux-libc-dev \</span><br><span class="line">    libstdc++-4.9-dev \</span><br><span class="line">    make \</span><br><span class="line">    manpages \</span><br><span class="line">    nano \</span><br><span class="line">    wget</span><br><span class="line"></span><br><span class="line">apt-get autoremove -y</span><br><span class="line">apt-get -q clean</span><br></pre></td></tr></table></figure>
<p>We can go a step further and remove Apt utilities as well, since we’re not going to install packages on a running system.</p>
<p>Don’t forget to disable the root login:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -L root</span><br></pre></td></tr></table></figure>
<p>Now, let’s remove some static files, caches, histories, logs and unused locales. Again, Ubuntu Wiki has a <a href="https://wiki.ubuntu.com/ReducingDiskFootprint#Drop_unnecessary_files">good rundown</a> of the process.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rm -rf \</span><br><span class="line">    /usr/share/applications \</span><br><span class="line">    /usr/share/apps \</span><br><span class="line">    /usr/share/doc \</span><br><span class="line">    /usr/share/games \</span><br><span class="line">    /usr/share/groff \</span><br><span class="line">    /usr/share/icons \</span><br><span class="line">    /usr/share/info \</span><br><span class="line">    /usr/share/linda \</span><br><span class="line">    /usr/share/lintian \</span><br><span class="line">    /usr/share/man \</span><br><span class="line">    /usr/share/pixmaps \</span><br><span class="line">    /var/cache/* \</span><br><span class="line">    /var/lib/apt/lists/* \</span><br><span class="line">    /var/<span class="built_in">log</span>/* \</span><br><span class="line">        2&gt; /dev/null || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">find /usr/share/locale -mindepth 1 -maxdepth 1 ! -name <span class="string">'en*'</span> \</span><br><span class="line">    ! -name <span class="string">'locale.alias'</span> | xargs rm -rf 2&gt; /dev/null || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">rm -rf ~/.bash_<span class="built_in">history</span> 2&gt; /dev/null || <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>The relevant part of the Dockerfile to run the author script:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span> <span class="bash">author.sh /scripts/</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">/scripts/author.sh</span></span><br></pre></td></tr></table></figure>
<p>The final step before making a firmware image is to remove temporary scripts and QEMU:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span> <span class="bash">rm /usr/bin/qemu-arm-static</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">rm -rf /scripts</span></span><br></pre></td></tr></table></figure>
<p>Now it’s time to build the firmware image using the <a href="#dockerfile">Dockerfile</a>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image_tag=georgesapkin/hal9000:$(date -I)</span><br><span class="line">docker build --tag=<span class="string">"<span class="variable">$image_tag</span>"</span> <span class="_">-f</span> Dockerfile .</span><br></pre></td></tr></table></figure>
<p>Since Docker stores all <a href="https://docs.docker.com/engine/userguide/storagedriver/imagesandcontainers/">individual layers</a>, you can structure your Dockerfile so that most-frequently changed scripts and commands are at the bottom. That way you can dramatically speed up your builds.</p>
<h2 id="Making-a-firmware-image-from-a-Docker-image"><a href="#Making-a-firmware-image-from-a-Docker-image" class="headerlink" title="Making a firmware image from a Docker image"></a>Making a firmware image from a Docker image</h2><p>First, let’s make a sparse image file, format it as ext4 and mount it. According to Wikipedia a <a href="https://en.wikipedia.org/wiki/Sparse_file">sparse file</a> is:</p>
<blockquote>
<p>…a type of computer file that attempts to use file system space more efficiently when the file itself is mostly empty. This is achieved by writing brief information (metadata) representing the empty blocks to disk instead of the actual “empty” space which makes up the block, using less disk space.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">size=500M</span><br><span class="line">rootfs_image=hal9000-$(date -I).img</span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="variable">$rootfs_image</span> bs=1 count=0 seek=<span class="variable">$size</span> status=none</span><br><span class="line"></span><br><span class="line">mkfs.ext4 -b 4096 -F <span class="variable">$rootfs_image</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$rootfs_dir</span></span><br><span class="line">mount -o loop <span class="variable">$rootfs_image</span> <span class="variable">$rootfs_dir</span></span><br></pre></td></tr></table></figure>
<p>It’s only possible to export from a Docker container, so we need to make a temporary one, export and then remote it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">container_name=hal9000-$(date -I)</span><br><span class="line">docker run --name <span class="variable">$container_name</span> <span class="variable">$tag</span> <span class="literal">true</span></span><br><span class="line">docker <span class="built_in">export</span> <span class="variable">$container_name</span> | tar -xf - -C <span class="variable">$rootfs_dir</span>/</span><br><span class="line">docker rm <span class="variable">$container_name</span></span><br></pre></td></tr></table></figure>
<p>Now we can unmount and pack the rootfs image:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">umount <span class="variable">$rootfs_dir</span></span><br><span class="line">gzip &lt; <span class="variable">$rootfs_image</span> &gt; <span class="variable">$rootfs_image</span>.gz</span><br></pre></td></tr></table></figure>
<h2 id="That’s-it"><a href="#That’s-it" class="headerlink" title="That’s it!"></a>That’s it!</h2><p>The firmware for our HAL 9000 is ready for flashing. You can flash it using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunzip -c rootfs.img.gz | dd of=/dev/your_device_root_partition bs=64K</span><br></pre></td></tr></table></figure>
<p>You may take it a step further and create a signed image using <code>cpio</code> and <code>openssl</code> that you can flash using <code>swupdate</code>. Or make an incremental over-the-air update.</p>
<p>To make this fully-automated you can hook it up to your <a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a> of choice and have a scheduled job (for the base image) or source repository triggers (for the firmware).</p>
<p>Feel free to ask questions in comments below or drop me an <a href="/contacts">email</a> if you need some advice.</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p><code>build.sh</code> - you’ll have to read the post for the comments :p</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line">rootfs_dir=rootfs</span><br><span class="line">distro=jessie</span><br><span class="line">debootstrap --arch=armhf --foreign <span class="variable">$distro</span> <span class="variable">$rootfs_dir</span></span><br><span class="line"></span><br><span class="line">qas=$(<span class="built_in">which</span> qemu-arm-static)</span><br><span class="line">cp <span class="variable">$qas</span> <span class="variable">$rootfs_dir</span><span class="variable">$qas</span></span><br><span class="line"></span><br><span class="line">chroot <span class="variable">$rootfs_dir</span> /debootstrap/debootstrap --second-stage</span><br><span class="line"></span><br><span class="line"><span class="built_in">pushd</span> . &gt; /dev/null</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$rootfs_dir</span></span><br><span class="line">tar -czf ../rootfs.tar.gz .</span><br><span class="line"><span class="built_in">popd</span> &gt; /dev/null</span><br><span class="line">rm -rf <span class="variable">$rootfs_dir</span></span><br><span class="line"></span><br><span class="line">tag=<span class="string">'georgesapkin/hal9000:base'</span></span><br><span class="line">docker import rootfs.tar.gz <span class="variable">$tag</span></span><br><span class="line"></span><br><span class="line">date=$(date -I)</span><br><span class="line">image_tag=georgesapkin/hal9000:<span class="variable">$date</span></span><br><span class="line">docker build --tag=<span class="string">"<span class="variable">$image_tag</span>"</span> <span class="_">-f</span> Dockerfile .</span><br><span class="line"></span><br><span class="line">size=500M</span><br><span class="line">rootfs_image=hal9000-<span class="variable">$date</span>.img</span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="variable">$rootfs_image</span> bs=1 count=0 seek=<span class="variable">$size</span> status=none</span><br><span class="line"></span><br><span class="line">mkfs.ext4 -b 4096 -F <span class="variable">$rootfs_image</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$rootfs_dir</span></span><br><span class="line">mount -o loop <span class="variable">$rootfs_image</span> <span class="variable">$rootfs_dir</span></span><br><span class="line"></span><br><span class="line">container_name=hal9000-<span class="variable">$date</span></span><br><span class="line">docker run --name <span class="variable">$container_name</span> <span class="variable">$tag</span> <span class="literal">true</span></span><br><span class="line">docker <span class="built_in">export</span> <span class="variable">$container_name</span> | tar -xf - -C <span class="variable">$rootfs_dir</span>/</span><br><span class="line">docker rm <span class="variable">$container_name</span></span><br><span class="line"></span><br><span class="line">umount <span class="variable">$rootfs_dir</span></span><br><span class="line">gzip &lt; <span class="variable">$rootfs_image</span> &gt; <span class="variable">$rootfs_image</span>.gz</span><br></pre></td></tr></table></figure>
<p><code>setup_some_feature.sh</code> - you <strong>really</strong> have to write your own.</p>
<p><code>author.sh</code> - this is a non-exhaustive sample. You will have different things to clean up in your firmware.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line">apt-get remove -y \</span><br><span class="line">    binutils \</span><br><span class="line">    build-essential \</span><br><span class="line">    cpp \</span><br><span class="line">    cpp-4.9 \</span><br><span class="line">    dpkg-dev \</span><br><span class="line">    g++ \</span><br><span class="line">    g++-4.9 \</span><br><span class="line">    gcc \</span><br><span class="line">    gcc-4.9 \</span><br><span class="line">    git \</span><br><span class="line">    git-man \</span><br><span class="line">    libc6-dev \</span><br><span class="line">    libc-dev-bin \</span><br><span class="line">    libgcc-4.9-dev \</span><br><span class="line">    linux-libc-dev \</span><br><span class="line">    libstdc++-4.9-dev \</span><br><span class="line">    make \</span><br><span class="line">    manpages \</span><br><span class="line">    nano \</span><br><span class="line">    wget</span><br><span class="line"></span><br><span class="line">apt-get autoremove -y</span><br><span class="line">apt-get -q clean</span><br><span class="line"></span><br><span class="line">usermod -L root</span><br><span class="line"></span><br><span class="line">rm -rf \</span><br><span class="line">    /usr/share/applications \</span><br><span class="line">    /usr/share/apps \</span><br><span class="line">    /usr/share/doc \</span><br><span class="line">    /usr/share/games \</span><br><span class="line">    /usr/share/groff \</span><br><span class="line">    /usr/share/icons \</span><br><span class="line">    /usr/share/info \</span><br><span class="line">    /usr/share/linda \</span><br><span class="line">    /usr/share/lintian \</span><br><span class="line">    /usr/share/man \</span><br><span class="line">    /usr/share/pixmaps \</span><br><span class="line">    /var/cache/* \</span><br><span class="line">    /var/lib/apt/lists/* \</span><br><span class="line">    /var/<span class="built_in">log</span>/* \</span><br><span class="line">        2&gt; /dev/null || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">find /usr/share/locale -mindepth 1 -maxdepth 1 ! -name <span class="string">'en*'</span> \</span><br><span class="line">    ! -name <span class="string">'locale.alias'</span> | xargs rm -rf 2&gt; /dev/null || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">rm -rf ~/.bash_<span class="built_in">history</span> 2&gt; /dev/null || <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><a name='dockerfile'></a><code>Dockerfile</code></p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> georgesapkin/hal9000:base</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span> <span class="bash">rootfs_overlay /</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">COPY</span> <span class="bash">kernel/boot         /</span><br><span class="line"></span><span class="keyword">COPY</span> <span class="bash">kernel/lib/firmware /lib/</span><br><span class="line"></span><span class="keyword">COPY</span> <span class="bash">kernel/lib/modules  /lib/</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">COPY</span> <span class="bash">setup_some_feature_1.sh /scripts/</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">/scripts/setup_some_feature_1.sh</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">COPY</span> <span class="bash">setup_some_feature_2.sh /scripts/</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">/scripts/setup_some_feature_2.sh</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">COPY</span> <span class="bash">author.sh /scripts/</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">/scripts/author.sh</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">RUN</span> <span class="bash">rm /usr/bin/qemu-arm-static</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">rm -rf /scripts</span></span><br></pre></td></tr></table></figure>
<p><a name='dpkg-filter'></a><code>/etc/dpkg/dpkg.cfg.d/01_filter</code> - from overlay</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">path-exclude=/usr/share/applications/*</span><br><span class="line">path-exclude=/usr/share/apps/*</span><br><span class="line">path-exclude=/usr/share/doc/*</span><br><span class="line">path-exclude=/usr/share/groff/*</span><br><span class="line">path-exclude=/usr/share/i18n/charmaps/*</span><br><span class="line">path-include=/usr/share/i18n/charmaps/UTF-8.gz</span><br><span class="line">path-exclude=/usr/share/i18n/locales/*</span><br><span class="line">path-include=/usr/share/i18n/locales/en_GB</span><br><span class="line">path-include=/usr/share/i18n/locales/en_US</span><br><span class="line">path-include=/usr/share/i18n/locales/i18n</span><br><span class="line">path-include=/usr/share/i18n/locales/iso14651_t1</span><br><span class="line">path-include=/usr/share/i18n/locales/iso14651_t1_common</span><br><span class="line">path-include=/usr/share/i18n/locales/translit_*</span><br><span class="line">path-exclude=/usr/share/icons/*</span><br><span class="line">path-exclude=/usr/share/info/*</span><br><span class="line">path-exclude=/usr/share/linda/*</span><br><span class="line">path-exclude=/usr/share/lintian/*</span><br><span class="line">path-exclude=/usr/share/locale/*</span><br><span class="line">path-include=/usr/share/locale/locale.alias</span><br><span class="line">path-include=/usr/share/locale/en_GB*</span><br><span class="line">path-include=/usr/share/locale/en_US*</span><br><span class="line">path-exclude=/usr/share/man/*</span><br><span class="line">path-exclude=/usr/share/pixmaps/*</span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"></div><div id="disqus_thread"></div><script>var disqus_shortname = 'dmesgw';
var disqus_identifier = '2016/06/12/device-firmware/';
var disqus_title = 'Making a Debian-based ARM device firmware';
var disqus_url = 'http://dmesg.sapk.in/2016/06/12/device-firmware/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//dmesgw.disqus.com/count.js" async></script><div class="copyright"><p>&copy; 2016 <a href="http://dmesg.sapk.in">George Sapkin</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-79232885-1",'auto');ga('send','pageview');</script></body></html>